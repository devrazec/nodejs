<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Handsontable CRUD</title>

  <!-- Handsontable CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/styles/handsontable.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/styles/ht-theme-main.min.css" />

  <style>
    #userTable {
      height: 'auto';
      width: 100%;
      margin-top: 20px;
    }
  </style>
</head>

<body>
  <h1>Handsontable CRUD</h1>

  <!-- Handsontable container -->
  <div id="userTable"></div>

  <!-- Socket.IO client -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

  <!-- Handsontable JS -->
  <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>

  <script>
    const socket = io(); // Connect to Socket.IO server

    // Reference to the container
    const container = document.getElementById('userTable');

    // Handsontable instance variable
    let hot;

    let usersData = [];

    async function fetchUsers() {
      try {
        const res = await fetch('/api/users');
        const data = await res.json();
        usersData = data;
        return data;
      } catch (err) {
        console.error('Failed to fetch users:', err);
        return [];
      }
    }

    // Function to initialize Handsontable
    function initTable(users) {
      hot = new Handsontable(container, {
        themeName: 'ht-theme-main',
        data: users,
        colHeaders: ['ID', 'First Name', 'Last Name', 'Phone', 'Email'],
        columns: [
          { data: 'id', readOnly: true },
          { data: 'firstname' },
          { data: 'lastname' },
          { data: 'phone' },
          { data: 'email' }
        ],
        dropdownMenu: true,
        hiddenColumns: {
          indicators: true
        },
        contextMenu: true,
        multiColumnSorting: true,
        filters: true,
        rowHeaders: true,
        manualRowMove: true,
        navigableHeaders: true,
        colHeaders: true,
        width: '100%',
        height: 'auto',
        //colWidths: 100,
        autoWrapRow: true,
        autoWrapCol: true,
        licenseKey: 'non-commercial-and-evaluation', // Required

        afterChange: async function (changes, source) {
          if (source === "loadData" || !changes) return;

          for (let [row, prop, oldValue, newValue] of changes) {
            if (oldValue === newValue) continue;

            const rowData = hot.getSourceDataAtRow(row);

            // UPDATE existing user
            if (rowData.id) {
              await fetch(`/api/users/${rowData.id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(rowData)
              });

              continue;
            }

            // CREATE new user
            if (!rowData.id && rowData.name && rowData.email) {
              await fetch(`/api/users`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  firstname: rowData.firstname,
                  lastname: rowData.lastname,
                  phone: rowData.phone,
                  email: rowData.email
                })
              });
            }
          }
        },

        contextMenu: {
          items: {

            new_row: {
              name: "Add User",
              callback: function () {
                const data = hot.getSourceData();

                // Add a new row with empty values
                data.push({
                  id: null,
                  firstname: "",
                  lastname: "",
                  phone: "",
                  email: ""
                });

                hot.loadData(data);

                // Focus on the new row, column "name"
                const newRow = data.length - 1;
                hot.selectCell(newRow, 1);
              }
            },
            remove_row: {
              name: "Delete user",
              callback: async function () {
                const row = hot.getSelected()[0][0];
                const user = hot.getSourceDataAtRow(row);

                if (!user || !user.id) {
                  // Local-only row â†’ simply remove it
                  hot.alter("remove_row", row);
                  return;
                }

                // Request backend deletion
                await fetch(`/api/users/${user.id}`, { method: "DELETE" });

                // Remove visually ONLY after backend confirms
                hot.alter("remove_row", row);
              }
            }
          }
        }
      });
    }

    // Load all existing users from server
    async function loadUsers() {
      const res = await fetch('/api/users');
      const users = await res.json();
      initTable(users);
    }

    // Real-time: Append new user into Handsontable

    socket.on("userCreated", (user) => {
      const existing = hot.getSourceData().find(u => u.id === user.id);
      if (existing) return; // prevent duplicates

      const newRow = hot.countRows();
      hot.alter("insert_row", newRow);
      hot.setSourceDataAtRow(newRow, user);
    });

    socket.on("userUpdated", (user) => {
      const data = hot.getSourceData();
      const index = data.findIndex(u => u.id === user.id);
      if (index === -1) return; // not found

      hot.setSourceDataAtRow(index, user);
    });

    socket.on("userDeleted", ({ id }) => {
      const data = hot.getSourceData();
      const row = data.findIndex(u => u.id === id);
      if (row >= 0) hot.alter("remove_row", row);
    });

    loadUsers();

    (async () => {
      const data = await fetchUsers();
      initTable(data);
    })();
    
  </script>

</body>

</html>