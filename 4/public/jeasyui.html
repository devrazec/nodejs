<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">

  <title>jEasyUI CRUD</title>

  <link rel="stylesheet" type="text/css" href="https://www.jeasyui.com/easyui/themes/default/easyui.css">
  <link rel="stylesheet" type="text/css" href="https://www.jeasyui.com/easyui/themes/icon.css">
  <link rel="stylesheet" type="text/css" href="https://www.jeasyui.com/easyui/themes/color.css">
  <script type="text/javascript" src="https://www.jeasyui.com/easyui/jquery.min.js"></script>
  <script type="text/javascript" src="https://www.jeasyui.com/easyui/jquery.easyui.min.js"></script>

  <!-- Socket.IO -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>

<body>

  <h1>jEasyUI CRUD</h1>

  <table id="dg" class="easyui-datagrid" style="width:100%;height:450px" fitColumns="true" singleSelect="true"
    url="/api/users" method="get" toolbar="#toolbar" rownumbers="true" pagination="true">
    <thead>
      <tr>
        <th field="id" width="15">ID</th>
        <th field="firstname" width="40">First Name</th>
        <th field="lastname" width="40">Last Name</th>
        <th field="phone" width="30">Phone</th>
        <th field="email" width="50">Email</th>
      </tr>
    </thead>
  </table>

  <div id="toolbar">
    <a onclick="createUser()" class="easyui-linkbutton" iconCls="icon-add">New</a>
    <a onclick="updateUser()" class="easyui-linkbutton" iconCls="icon-edit">Edit</a>
    <a onclick="deleteUser()" class="easyui-linkbutton" iconCls="icon-remove">Delete</a>
  </div>

  <!-- Dialog form -->
  <div id="dlg" class="easyui-dialog" style="width:400px" closed="true" modal="true" buttons="#dlg-buttons">
    <form id="fm" style="margin:0;padding:20px 40px">
      <input name="firstname" class="easyui-textbox" required label="First Name:" style="width:100%">
      <input name="lastname" class="easyui-textbox" required label="Last Name:" style="width:100%">
      <input name="phone" class="easyui-textbox" required label="Phone:" style="width:100%">
      <input name="email" class="easyui-textbox" required validType="email" label="Email:" style="width:100%">
    </form>
  </div>

  <div id="dlg-buttons">
    <a href="javascript:void(0)" class="easyui-linkbutton c6" iconCls="icon-ok" onclick="submitUserForm()"
      style="width:90px">Save</a>
    <a class="easyui-linkbutton" iconCls="icon-cancel" onclick="$('#dlg').dialog('close')">Cancel</a>
  </div>

  <script>

    const socket = io();

    let formAction = {
      url: '',
      method: ''
    };

    function setCreateEndpoint() {
      formAction.url = '/api/users/';
      formAction.method = 'post';
    }

    function setUpdateEndpoint(id) {
      formAction.url = '/api/users/' + id;
      formAction.method = 'put';
    }

    // NEW User
    function createUser() {
      $('#dlg').dialog('open').dialog('setTitle', 'New User');
      $('#fm').form('clear');
      setCreateEndpoint();
    }

    // EDIT User
    function updateUser() {
      const row = $('#dg').datagrid('getSelected');
      if (!row) {
        return $.messager.alert('Warning', 'Select a user to edit');
      }

      $('#dlg').dialog('open').dialog('setTitle', 'Edit User');
      $('#fm').form('load', row);

      setUpdateEndpoint(row.id);
    }

    // SAVE (Create or Update)
    function submitUserForm() {
      // Validate EasyUI form
      if (!$('#fm').form('validate')) {
        $.messager.alert('Error', 'Please fill in all required fields.');
        return;
      }

      // Serialize form data
      const data = $('#fm').serializeArray().reduce((obj, item) => {
        obj[item.name] = item.value;
        return obj;
      }, {});

      fetch(formAction.url, {
        method: formAction.method.toUpperCase(), // 'POST' or 'PUT'
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
        .then(res => res.json())
        .then(result => {
          if (result.error) {
            $.messager.show({ title: 'Error', msg: result.error });
          } else {
            $('#dlg').dialog('close');       // Close dialog
            $('#dg').datagrid('reload');     // Refresh datagrid
            const msg = formAction.method === 'post' ? 'User created successfully!' : 'User updated successfully!';
            $.messager.show({ title: 'Success', msg });
          }
        })
        .catch(err => {
          console.error(err);
          $.messager.show({ title: 'Error', msg: 'Network or server error.' });
        });
    }

    // DELETE User
    function deleteUser() {
      const row = $('#dg').datagrid('getSelected');
      if (!row) return $.messager.alert('Warning', 'Select a user to delete');

      $.messager.confirm('Confirm', 'Are you sure you want to delete this user?', function (r) {
        if (!r) return;

        fetch('/api/users/' + row.id, {
          method: 'DELETE'
        })
          .then(res => res.json())
          .then(result => {
            if (result.error) {
              $.messager.show({ title: 'Error', msg: result.error });
            } else {
              $('#dg').datagrid('reload');
              $.messager.show({ title: 'Success', msg: 'User deleted!' });
            }
          })
          .catch(err => $.messager.show({ title: 'Error', msg: 'Network error.' }));
      });
    }


    // ------------------------------------
    // REAL-TIME SOCKET.IO EVENT LISTENERS
    // ------------------------------------

    socket.on("userCreated", () => {
      $('#dg').datagrid('reload');
    });

    socket.on("userUpdated", () => {
      $('#dg').datagrid('reload');
    });

    socket.on("userDeleted", () => {
      $('#dg').datagrid('reload');
    });
  </script>

</body>

</html>