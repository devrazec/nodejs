<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Handsontable CRUD</title>

    <!-- Handsontable CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/styles/handsontable.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/styles/ht-theme-main.min.css" />

    <style>
        #userTable {
            height: 'auto';
            width: 100%;
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <h1>Handsontable CRUD</h1>

    <!-- Handsontable container -->
    <div id="userTable"></div>

    <!-- Socket.IO client -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <!-- Handsontable JS -->
    <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>

    <script>
        const socket = io(); // connect to server
        let hot;
        let usersData = [];

        // Fetch users from backend
        async function fetchUsers() {
            try {
                const res = await fetch('/api/users');
                const data = await res.json();
                usersData = data;
                return data;
            } catch (err) {
                console.error('Failed to fetch users:', err);
                return [];
            }
        }

        // Initialize Handsontable
        async function initTable() {
            const data = await fetchUsers();
            const container = document.getElementById('userTable');

            hot = new Handsontable(container, {
                themeName: 'ht-theme-main',
                data: data,
                colHeaders: ['ID', 'Firstname', 'Lastname', 'Email', 'Phone'],
                columns: [
                    { data: 'id', readOnly: true },
                    { data: 'firstname' },
                    { data: 'lastname' },
                    { data: 'email' },
                    { data: 'phone' }
                ],
                rowHeaders: true,
                width: '100%',
                height: 500,
                licenseKey: 'non-commercial-and-evaluation',
                stretchH: 'all',
                manualColumnResize: true,
                manualRowMove: true,
                contextMenu: {
                    items: {
                        new_row: {
                            name: "New",
                            callback: function () {
                                const data = hot.getSourceData(); // current data array

                                // Add a new empty row
                                const newRow = {
                                    id: null,
                                    firstname: "",
                                    lastname: "",
                                    email: "",
                                    phone: ""
                                };
                                data.push(newRow);

                                // Update Handsontable with the new data
                                hot.loadData(data);

                                // Focus the new row
                                hot.selectCell(data.length - 1, 1);
                            }
                        },

                        remove_row: {
                            name: "Delete",
                            callback: async function () {
                                const selection = hot.getSelected();
                                if (!selection || selection.length === 0) return;

                                // Get the first selected row
                                const row = selection[0][0];
                                const rowData = hot.getSourceDataAtRow(row);

                                if (!rowData.id) {
                                    // Unsaved row, remove it safely
                                    hot.alter('remove_row', row);
                                    return;
                                }

                                try {
                                    const res = await fetch(`/api/users/${rowData.id}`, { method: 'DELETE' });
                                    const result = await res.json();
                                    if (result.error) {
                                        console.error(result.error);
                                        return;
                                    }

                                    // Remove row safely in v16+
                                    hot.deselectCell();               // Clear selection first
                                    hot.alter('remove_row', row, 1);

                                } catch (err) {
                                    console.error('Delete error:', err);
                                }
                            }
                        }
                    }
                },

                afterChange: async function (changes, source) {
                    if (!changes || source === 'loadData' || source === 'remove_row') return;

                    for (const [row, prop, oldValue, newValue] of changes) {
                        if (oldValue === newValue) continue;

                        const rowData = hot.getSourceDataAtRow(row);

                        try {
                            if (!rowData.id) {
                                if (!rowData.id && rowData.firstname && rowData.lastname && rowData.phone && rowData.email) {
                                    // Create new user
                                    const res = await fetch('/api/users', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({
                                            firstname: rowData.firstname,
                                            lastname: rowData.lastname,
                                            phone: rowData.phone,
                                            email: rowData.email
                                        })
                                    });
                                    const created = await res.json();
                                    rowData.id = created.id; // assign new ID
                                    // Emit created event handled by server
                                    hot.setDataAtRowProp(row, 'id', created.id);
                                }
                            } else {
                                // Update existing user
                                await fetch(`/api/users/${rowData.id}`, {
                                    method: 'PUT',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(rowData)
                                });
                                // Emit updated event handled by server
                            }
                        } catch (err) {
                            console.error('Save error:', err);
                        }
                    }
                }
            });
        }

        // Real-time updates via Socket.IO
        socket.on("userCreated", (user) => {
            const data = hot.getSourceData();
            if (data.find(u => u.id === user.id)) return; // prevent duplicates

            data.push({
                id: user.id,
                firstname: user.firstname,
                lastname: user.lastname,
                email: user.email,
                phone: user.phone
            });

            // Reload the updated table
            hot.loadData(data);

            // Optional: scroll to the bottom & highlight new row
            const newRowIndex = data.length - 1;
            hot.selectCell(newRowIndex, 1);
        });

        socket.on("userUpdated", (user) => {
            const data = hot.getSourceData();
            const index = data.findIndex(u => u.id === user.id);
            if (index === -1) return;
            Object.keys(user).forEach(key => {
                hot.setDataAtRowProp(index, key, user[key]);
            });
        });

        socket.on("userDeleted", ({ id }) => {
            const data = hot.getSourceData();
            const rowIndex = data.findIndex(u => u.id === id);
            if (rowIndex >= 0) hot.alter("remove_row", rowIndex);
        });

        // Initialize table on page load
        initTable();
    </script>
</body>

</html>