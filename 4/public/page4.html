<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Handsontable CRUD Inline</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@11.1.0/dist/handsontable.full.min.css">
    <script src="https://cdn.jsdelivr.net/npm/handsontable@11.1.0/dist/handsontable.full.min.js"></script>
    <style>
        #hot {
            width: 100%;
            height: 500px;
            margin: 20px 0;
        }
    </style>
</head>

<body>
    <div id="hot"></div>

    <script>
        let hot;
        let usersData = [];

        function fetchUsers() {
            return fetch('/api/users')
                .then(res => res.json())
                .then(data => { usersData = data; return data; });
        }

        function initTable(data) {
            const container = document.getElementById('hot');

            hot = new Handsontable(container, {
                data: data,
                colHeaders: ['ID', 'Firstname', 'Lastname', 'Email', 'Phone'],
                columns: [
                    { data: 'id', readOnly: true },
                    { data: 'firstname' },
                    { data: 'lastname' },
                    { data: 'email' },
                    { data: 'phone' }
                ],
                rowHeaders: true,
                width: '100%',
                height: 500,
                licenseKey: 'non-commercial-and-evaluation',
                stretchH: 'all',
                manualColumnResize: true,
                manualRowMove: true,
                contextMenu: {
                    callback: function (key, selection) {
                        const row = selection[0].start.row;
                        const rowData = hot.getSourceDataAtRow(row);

                        if (key === 'delete_row') {
                            if (!rowData.id) return hot.alter('remove_row', row); // unsaved new row
                            Swal.fire({
                                title: 'Confirm Delete',
                                text: `Delete user ${rowData.firstname} ${rowData.lastname}?`,
                                icon: 'warning',
                                showCancelButton: true,
                                confirmButtonText: 'Yes, delete!'
                            }).then(result => {
                                if (!result.isConfirmed) return;
                                fetch('/api/users/' + rowData.id, { method: 'DELETE' })
                                    .then(res => res.json())
                                    .then(result => {
                                        if (result.error) Swal.fire('Error', result.error, 'error');
                                        else fetchUsers().then(data => hot.loadData(data));
                                    });
                            });
                        }

                        if (key === 'create_row') {
                            hot.alter('insert_row', row + 1);
                            hot.setDataAtRowProp(row + 1, 'id', null); // new row has no id yet
                        }
                    },
                    items: {
                        "create_row": { name: "New" },
                        "remove_row": { name: "Delete" }
                    }
                },
                afterChange: function (changes, source) {
                    if (source === 'loadData' || !changes) return;

                    changes.forEach(([row, prop, oldValue, newValue]) => {
                        if (oldValue === newValue) return;

                        const rowData = hot.getSourceDataAtRow(row);

                        if (!rowData.id) {
                            // New user
                            fetch('/api/users', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(rowData)
                            })
                                .then(res => res.json())
                                .then(created => {
                                    rowData.id = created.id; // set ID in Handsontable
                                    fetchUsers().then(data => hot.loadData(data));
                                })
                                .catch(err => console.error(err));
                        } else {
                            // Existing user update
                            fetch('/api/users/' + rowData.id, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(rowData)
                            })
                                .then(res => res.json())
                                .then(updated => fetchUsers().then(data => hot.loadData(data)))
                                .catch(err => console.error(err));
                        }
                    });
                }
            });
        }

        // Initialize table
        fetchUsers().then(data => initTable(data));
    </script>
</body>

</html>