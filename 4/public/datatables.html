<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Datatables CRUD</title>

    <link rel="stylesheet" type="text/css" href="./libs/datatables/css/datatables.min.css">
    <link rel="stylesheet" type="text/css" href="./libs/datatables/css/jquery.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="/editor-dt/editor.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="./libs/datatables/css/buttons.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="./libs/datatables/css/select.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="./libs/datatables/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="./libs/datatables/css/colReorder.dataTables.min.css">

    <script src="./libs/jquery/jquery-3.3.1.min.js"></script>
    <script src="./libs/datatables/js/datatables.min.js"></script>
    <script src="./libs/datatables/js/jquery.dataTables.min.js"></script>
    <script src="/editor/dataTables.editor.min.js"></script>

    <script type="text/javascript" language="javascript" src="./libs/datatables/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" language="javascript" src="./libs/datatables/js/dataTables.select.min.js"></script>
    <script type="text/javascript" language="javascript" src="./libs/datatables/js/buttons.print.min.js"></script>
    <script type="text/javascript" language="javascript"
        src="./libs/datatables/js/dataTables.rowReorder.min.js"></script>
    <script type="text/javascript" language="javascript" src="./libs/datatables/js/jszip.min.js"></script>
    <script type="text/javascript" language="javascript" src="./libs/datatables/js/pdfmake.min.js"></script>
    <script type="text/javascript" language="javascript" src="./libs/datatables/js/vfs_fonts.js"></script>
    <script type="text/javascript" language="javascript" src="./libs/datatables/js/buttons.html5.min.js"></script>
    <script type="text/javascript" language="javascript" src="./libs/datatables/js/buttons.print.min.js"></script>


    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>

<body>

    <h1>Datatables CRUD</h1>

    <table id="usersTable" class="display" width="100%">
        <thead>
            <tr>
                <th>ID</th>
                <th>First name</th>
                <th>Last name</th>
                <th>Phone</th>
                <th>Email</th>
            </tr>
        </thead>
    </table>

    <script>

        let table;
        let editor;
        const socket = io();

        $(document).ready(function () {

            // -----------------------------
            // DATATABLES EDITOR
            // -----------------------------
            editor = new $.fn.dataTable.Editor({
                ajax: function (method, url, data, successCallback, errorCallback) {
                    var action = data.action;
                    var id = Object.keys(data.data || {})[0]; // get row ID
                    var payload = Object.assign({}, data.data[id]); // copy row data

                    // Remove ID for PUT (edit) requests
                    if (action === 'edit') {
                        delete payload.id;
                    }

                    var ajaxOptions = {
                        contentType: "application/json",
                        dataType: "json",
                        success: successCallback,
                        error: errorCallback
                    };

                    if (action === 'create') {
                        ajaxOptions.type = 'POST';
                        ajaxOptions.url = '/api/users';
                        ajaxOptions.data = JSON.stringify(payload);
                    } else if (action === 'edit') {
                        ajaxOptions.type = 'PUT';
                        ajaxOptions.url = '/api/users/' + id;
                        ajaxOptions.data = JSON.stringify(payload);
                    } else if (action === 'remove') {
                        ajaxOptions.type = 'DELETE';
                        ajaxOptions.url = '/api/users/' + id;
                    }

                    $.ajax(ajaxOptions);
                },

                table: "#usersTable",
                idSrc: "id",
                fields: [
                    { label: "ID:", name: "id", type: "readonly" },
                    { label: "First name:", name: "firstname" },
                    { label: "Last name:", name: "lastname" },
                    { label: "Phone:", name: "phone" },
                    { label: "Email:", name: "email" }
                ]
            });

            editor.on('submitComplete', function () {
                editor.close();
            });

            // -----------------------------
            // DATATABLE
            // -----------------------------
            table = $('#usersTable').DataTable({
                ajax: {
                    url: '/api/users',
                    dataSrc: ''
                },
                columns: [
                    { data: 'id' },
                    { data: 'firstname' },
                    { data: 'lastname' },
                    { data: 'phone' },
                    { data: 'email' },
                ],
                select: {
                    style: 'single'
                },
                dom: 'Bfrtip',
                buttons: [
                    { extend: 'create', editor: editor },
                    { extend: 'edit', editor: editor },
                    {
                        extend: "remove",
                        editor: editor,
                        formMessage: function (e, dt) {
                            return 'Are you sure you want to delete this user?';
                        }
                    },
                    {
                        extend: 'collection',
                        text: 'Export',
                        buttons: [
                            'copy',
                            'excel',
                            'csv',
                            'pdf',
                            'print'
                        ]
                    }
                ]
            });

        });

        // ------------------------------------
        // REAL-TIME SOCKET.IO EVENT LISTENERS
        // ------------------------------------

        socket.on("userCreated", (user) => {
            table.row.add(user).draw(false);
        });

        socket.on("userUpdated", (user) => {
            const index = table.rows().indexes().filter(i => table.row(i).data().id === user.id);
            if (index.length) {
                table.row(index[0]).data(user).draw(false);
            }
        });

        socket.on("userDeleted", ({ id }) => {
            table.rows(function (idx, data) {
                return data.id === id;
            }).remove().draw(false);
        });

    </script>

</body>

</html>